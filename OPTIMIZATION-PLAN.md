# 视频播放器优化计划

## 📊 当前状态

### ✅ 已实现
- 多格式支持：MP4, WebM, OGG, HLS, DASH, FLV
- 引擎工厂模式
- 自动格式检测
- 降级策略
- 基础播放控制
- 播放列表管理
- 字幕支持

### ✅ 已完成优化
- ✅ 性能优化（事件节流、内存管理）
- ✅ 高级功能（画中画、截图、质量切换）
- ✅ 播放统计功能
- ✅ 播放历史（断点续播）
- ✅ 字幕样式自定义
- ✅ 播放速度/音量记忆
- ✅ 预加载策略

### ✅ 已完成优化
- ✅ RTMP 格式支持（自动转换为 HTTP-FLV）
- ✅ 构造函数中功能初始化（已启用 enablePlaybackHistory、saveSettings、preloadStrategy）

### ⚠️ 待优化/改进
- 无（所有核心优化已完成）

---

## 🚀 优化方案

### 1. 性能优化

#### 1.1 事件监听器优化
- **问题**：`timeupdate` 事件触发频率过高（每秒多次）
- **方案**：使用节流（throttle）限制事件触发频率
- **收益**：减少 CPU 占用，提升性能

#### 1.2 内存管理优化
- **问题**：引擎切换时可能未完全清理资源
- **方案**：
  - 确保旧引擎完全销毁
  - 清理事件监听器
  - 释放媒体资源
- **收益**：避免内存泄漏

#### 1.3 预加载策略
- **问题**：播放列表切换时加载延迟
- **方案**：
  - 预加载下一个视频的元数据
  - 智能预加载策略（根据网络状况）
- **收益**：提升播放流畅度

#### 1.4 防抖/节流优化
- **问题**：频繁操作（如拖拽进度条）触发过多事件
- **方案**：对 `seeking`、`volumechange` 等事件进行防抖
- **收益**：减少不必要的处理

---

### 2. 功能增强

#### 2.1 画中画模式（Picture-in-Picture）
- **功能**：支持浏览器原生画中画 API
- **API**：`requestPictureInPicture()`
- **收益**：提升用户体验

#### 2.2 截图功能
- **功能**：使用 Canvas API 截取当前帧
- **实现**：`canvas.drawImage(video, ...)`
- **收益**：支持视频截图

#### 2.3 播放质量切换
- **功能**：HLS/DASH 支持手动切换质量级别
- **实现**：
  - HLS: `hls.levels`, `hls.currentLevel`
  - DASH: `player.getBitrateInfoListFor()`, `player.setQualityFor()`
- **收益**：用户可控制播放质量

#### 2.4 播放统计
- **功能**：记录播放时长、缓冲次数、错误统计
- **实现**：事件监听 + 数据统计
- **收益**：可用于分析和优化

#### 2.5 播放历史
- **功能**：记录播放位置，支持断点续播
- **实现**：LocalStorage + 播放位置记录
- **收益**：提升用户体验

#### 2.6 字幕样式自定义
- **功能**：支持字幕颜色、大小、位置等样式
- **实现**：CSS 样式注入
- **收益**：个性化字幕显示

#### 2.7 播放速度记忆
- **功能**：记住用户的播放速度偏好
- **实现**：LocalStorage 存储
- **收益**：个性化体验

#### 2.8 音量记忆
- **功能**：记住用户的音量设置
- **实现**：LocalStorage 存储
- **收益**：个性化体验

---

### 3. 格式支持扩展

#### 3.1 RTMP 支持
- **方案一**：使用 WebRTC 转 RTMP（复杂）
- **方案二**：使用 flv.js 支持 HTTP-FLV（推荐）
- **方案三**：使用第三方 RTMP 播放器（如 video.js）
- **状态**：当前已检测 RTMP，但未实现播放

#### 3.2 M3U8 播放列表增强
- **功能**：支持多码率自适应列表解析
- **实现**：解析 M3U8 文件，提取质量级别
- **收益**：更好的自适应码率支持

#### 3.3 更多流媒体协议
- **WebRTC**：实时流媒体（需要信令服务器）
- **SRT**：安全可靠传输（需要转码）
- **状态**：未来扩展

---

## 📝 实施优先级

### 高优先级（立即实施）
1. ✅ 事件监听器节流优化
2. ✅ 内存管理优化
3. ✅ 画中画模式支持
4. ✅ 截图功能
5. ✅ 播放质量切换（HLS/DASH）

### 中优先级（近期实施）
1. ✅ 播放统计功能
2. ✅ 播放历史（断点续播）
3. ✅ 字幕样式自定义
4. ✅ 预加载策略优化
5. ✅ 构造函数初始化优化（启用功能选项）

### 低优先级（未来扩展）
1. ⏳ RTMP 支持（HTTP-FLV）
2. ⏳ 播放速度/音量记忆
3. ⏳ 更多流媒体协议

---

## 🔧 技术实现细节

### 事件节流示例
```typescript
function throttle<T extends (...args: any[]) => void>(
  func: T,
  delay: number
): T {
  let lastCall = 0;
  return ((...args: Parameters<T>) => {
    const now = Date.now();
    if (now - lastCall >= delay) {
      lastCall = now;
      func(...args);
    }
  }) as T;
}

// 使用
this.video.addEventListener('timeupdate', throttle(() => {
  this.emit('timeupdate');
}, 250)); // 每 250ms 最多触发一次
```

### 画中画示例
```typescript
async enterPictureInPicture(): Promise<void> {
  if (this.video.requestPictureInPicture) {
    await this.video.requestPictureInPicture();
  }
}

exitPictureInPicture(): void {
  if (document.pictureInPictureElement) {
    document.exitPictureInPicture();
  }
}
```

### 截图示例
```typescript
captureFrame(format: 'image/png' | 'image/jpeg' = 'image/png'): string {
  const canvas = document.createElement('canvas');
  canvas.width = this.video.videoWidth;
  canvas.height = this.video.videoHeight;
  const ctx = canvas.getContext('2d')!;
  ctx.drawImage(this.video, 0, 0);
  return canvas.toDataURL(format);
}
```

---

## 📈 预期收益

### 性能提升
- CPU 占用降低 30-50%（事件节流）
- 内存泄漏减少 90%（资源清理）
- 播放流畅度提升 20%（预加载）

### 功能增强
- 用户体验提升（画中画、截图、质量切换）
- 个性化体验（播放历史、设置记忆）
- 更好的兼容性（RTMP 支持）

---

## 🎯 下一步行动

1. ✅ **已完成**：事件节流和内存管理优化
2. ✅ **已完成**：画中画、截图、质量切换功能
3. ✅ **已完成**：播放统计、播放历史、字幕样式
4. ✅ **已完成**：构造函数初始化优化
5. ✅ **已完成**：RTMP 支持完善（包括连接状态监控）

---

## 🚀 继续优化建议

### 1. 性能优化增强

#### 1.1 网络状态检测 ✅
- **功能**：检测网络速度，自动调整预加载策略
- **实现**：使用 `navigator.connection` API
- **收益**：在慢速网络下减少带宽浪费
- **状态**：✅ 已实现 - `setupNetworkMonitoring()` 方法，自动监控网络状态变化

#### 1.2 视频缓冲优化 ✅
- **功能**：智能缓冲管理，根据网络状况调整缓冲大小
- **实现**：监控 `video.buffered`，动态调整预加载范围
- **收益**：减少内存占用，提升播放流畅度
- **状态**：✅ 已实现 - `optimizeBuffering()` 方法，根据网络状态优化缓冲策略

#### 1.3 事件监听器优化 ✅
- **功能**：对 `seeking` 事件也进行节流
- **实现**：使用 throttle 包装 seeking 事件处理
- **收益**：减少拖拽进度条时的性能开销
- **状态**：✅ 已实现 - `throttledSeeking` 处理器，每 100ms 最多触发一次

### 2. 功能增强

#### 2.1 自动格式选择 ✅
- **功能**：根据浏览器支持情况自动选择最佳格式
- **实现**：使用 `getRecommendedFormats()` 和 `isAV1Supported()`
- **收益**：自动选择最佳视频格式，提升兼容性
- **状态**：✅ 已实现 - 在 `loadSource()` 中自动选择推荐格式

#### 2.2 多源降级策略 ✅
- **功能**：当主源失败时，自动切换到备用源
- **实现**：使用 `fallbackSources` 选项
- **收益**：提升播放成功率
- **状态**：✅ 已实现 - `loadWithRetry()` 方法，支持自动降级和重试

#### 2.3 播放速度快捷键 ✅
- **功能**：支持键盘快捷键调整播放速度（如 `[` 和 `]`）
- **实现**：在 `setupKeyboardShortcuts` 中添加
- **收益**：提升用户体验
- **状态**：✅ 已实现 - 支持 `[`/`]` 调整速度，`0` 重置速度

#### 2.4 视频信息显示 ✅
- **功能**：显示当前视频格式、质量级别、码率等信息
- **实现**：添加 `getVideoInfo()` 方法
- **收益**：便于调试和用户了解播放状态
- **状态**：✅ 已实现 - `getVideoInfo()` 和 `getBufferedInfo()` 方法

### 3. RTMP 支持完善

#### 3.1 自动 RTMP 转换 ✅
- **功能**：自动将 RTMP URL 转换为 HTTP-FLV
- **实现**：在 `loadSource` 中自动处理 RTMP URL
- **收益**：用户无需手动转换 URL
- **状态**：✅ 已实现 - 自动检测并转换 RTMP URL

#### 3.2 RTMP 连接状态监控 ✅
- **功能**：监控 RTMP 连接状态，自动重连
- **实现**：监听连接事件，实现重连逻辑
- **收益**：提升直播流稳定性
- **状态**：✅ 已实现 - FLV 引擎支持连接状态监控和自动重连
  - 监听 flv.js 的 NETWORK_STATUS 和 ERROR 事件
  - 实现自动重连机制（可配置重连次数和延迟）
  - 提供 `getConnectionStatus()` 和 `reconnect()` 方法
  - 支持 `connectionstatuschange` 事件

### 4. 错误处理增强

#### 4.1 错误重试机制 ✅
- **功能**：播放失败时自动重试
- **实现**：添加重试计数器和指数退避
- **收益**：提升播放成功率
- **状态**：✅ 已实现 - `loadWithRetry()` 方法，支持指数退避重试

#### 4.2 错误信息详细化 ✅
- **功能**：提供更详细的错误信息和建议
- **实现**：错误对象包含错误类型、建议等
- **收益**：便于用户理解和解决问题
- **状态**：✅ 已实现 - `createDetailedError()` 方法，包含错误类型和建议

### 5. 可访问性增强

#### 5.1 键盘导航增强 ✅
- **功能**：支持更多键盘快捷键
- **实现**：添加字幕切换、质量切换等快捷键
- **收益**：提升可访问性
- **状态**：✅ 已实现 - 支持 `S` 切换字幕，`Q` 切换质量，`[`/`]` 调整速度

#### 5.2 ARIA 标签支持 ✅
- **功能**：为视频元素添加 ARIA 标签
- **实现**：设置 `aria-label`、`aria-describedby` 等
- **收益**：提升屏幕阅读器支持
- **状态**：✅ 已实现 - 在构造函数中设置 ARIA 属性

### 6. 开发者体验

#### 6.1 TypeScript 类型增强 ✅
- **功能**：更完善的类型定义
- **实现**：添加更多泛型和工具类型
- **收益**：提升开发体验
- **状态**：✅ 已实现 - 添加了 `debug` 和 `maxRetries` 选项类型

#### 6.2 调试模式 ✅
- **功能**：开发模式下输出详细日志
- **实现**：添加 `debug` 选项
- **收益**：便于调试和问题排查
- **状态**：✅ 已实现 - 支持 `debug` 选项，输出详细日志
